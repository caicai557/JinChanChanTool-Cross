# Windows 稳定版运行时链路资料

## 1. 主循环目标
在商店刷新节奏内完成一轮闭环：
- 识别当前商店卡牌
- 匹配目标阵容/英雄
- 决策买牌与刷新
- 执行动作并更新状态

## 2. 运行时链路（逻辑视角）
1. 读取当前配置和坐标。
2. 截图（店铺卡位、按钮、可选区域）。
3. OCR 识别与文本纠错。
4. 匹配决策（是否命中目标、是否刷新、是否跳过）。
5. 动作执行（鼠标或键盘）。
6. 记录日志和指标，更新窗体状态。

## 3. 线程与耦合现状
- 主循环与 UI 状态更新存在紧耦合。
- 部分调用路径在高频循环中直接访问 UI 状态或依赖 UI 参数。
- 异常被分散处理，统一故障追踪难度高。

## 4. 性能热点
- 高频路径对象分配（字符串、数组、临时容器）较多。
- OCR 调度与循环节拍耦合，阻塞时会放大抖动。
- 覆盖层与状态输出在高频阶段可能增加 UI 压力。

## 5. 可观测性现状
- 指标字段已经存在基础定义，但采样和聚合不统一。
- 建议统一输出以下固定指标：
  - `CaptureMs`
  - `OcrMs`
  - `CorrectionMs`
  - `MatchMs`
  - `ActionMs`
  - `LoopTotalMs`

## 6. 稳定性痛点
- 部分异常被捕获后仅提示或吞掉，无法定位根因。
- 运行时路径长，且跨 UI/服务/工具层跳转多。
- 长时间运行下，抖动来源难以快速归因（OCR、输入注入、坐标状态、线程竞争）。

## 7. 双端重构继承建议
- 保留“单循环、固定阶段、固定指标”模型。
- 把 OCR、匹配、刷新、执行拆成独立服务并以接口连接。
- UI 只消费快照，不直接驱动核心决策。
